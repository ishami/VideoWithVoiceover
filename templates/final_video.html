{% extends "base.html" %}
{% block title %}Preview{% endblock %}

{% block content %}
<div class="video-container">
    <h2>Final Video</h2>

    {% if debug_info %}
    <div class="alert alert-info mb-3">
        <h4>Debug Information</h4>
        <pre>{{ debug_info|tojson(indent=2) }}</pre>
        <a href="/test-video" class="btn btn-primary" target="_blank">Open Test Video Page</a>
    </div>
    {% endif %}

    <div id="loading-indicator" {% if filename %}style="display:none"{% endif %}>
        <div class="alert alert-info">
            <p>Checking video status...</p>
            <div class="progress">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%" aria-valuenow="0"></div>
            </div>
            <p id="status-message">Checking status...</p>
            <button onclick="manualCheckStatus()" class="btn btn-info me-2">Check Status</button>
            <button onclick="regenerateVideo()" class="btn btn-primary">Generate Video</button>
            <button onclick="window.location.reload()" class="btn btn-warning ms-2">Force Reload</button>
        </div>
    </div>

    <div id="video-player" {% if not filename %}style="display:none"{% endif %}>
        <div class="alert alert-success mb-3">
            <strong>Video Ready!</strong> Your video has been generated successfully.
        </div>
        <video width="800" controls autoplay>
            <source id="video-source" src="{% if filename %}/static/videos/{{ filename }}?t={{ now().timestamp() }}{% endif %}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="mt-3 video-controls">
            <a id="download-link" href="{% if filename %}/static/videos/{{ filename }}?download=1{% endif %}" class="btn btn-primary">Download</a>
            <button onclick="showUploadDialog()" class="btn btn-success ms-2">Upload to Social Media</button>
            <button onclick="location.href='{{ url_for('clips') }}'" class="btn btn-outline-secondary ms-2">Return to Clips</button>
            <button onclick="regenerateVideo()" class="btn btn-warning ms-2">Regenerate Video</button>
        </div>
    </div>
</div>

<!-- YouTube Auth Prompt (shows when YouTube connection is required) -->
<div id="youtube-auth-required" style="display:none; margin:20px 0;">
  <div class="alert alert-danger">
    <strong>Your YouTube connection has expired or is missing.</strong><br>
    Please <a class="btn btn-danger" href="/authorize_youtube">Connect your YouTube account</a> to upload videos.
  </div>
</div>

<!-- Enhanced Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">Upload to Social Media</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Platform Selection -->
        <div class="mb-3">
          <label for="platformSelect" class="form-label">Select Platform</label>
          <select class="form-select" id="platformSelect" onchange="onPlatformChange()">
            <option value="">Choose platform...</option>
            <option value="youtube">YouTube</option>
            <option value="youtube_shorts">YouTube Shorts</option>
            <option value="facebook">Facebook</option>
            <option value="instagram">Instagram</option>
            <option value="tiktok">TikTok</option>
          </select>
        </div>

        <!-- YouTube Options (shown when YouTube is selected) -->
        <div id="youtubeOptions" style="display:none;">
          <div class="mb-3">
            <label for="videoTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="videoTitle" maxlength="100">
            <div class="form-text">Maximum 100 characters</div>
          </div>
          <div class="mb-3">
            <label for="videoDescription" class="form-label">Description</label>
            <textarea class="form-control" id="videoDescription" rows="6" maxlength="5000"></textarea>
            <div class="form-text">
              <span id="descriptionCount">0</span> / 5000 characters
            </div>
          </div>
          <div class="mb-3">
            <label for="videoTags" class="form-label">Tags (comma separated)</label>
            <textarea class="form-control" id="videoTags" rows="2" placeholder="tag1, tag2, tag3"></textarea>
            <div class="form-text">Maximum 500 characters total, individual tags max 30 characters</div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="privacySelect" class="form-label">Privacy</label>
                <select class="form-select" id="privacySelect">
                  <option value="private" selected>Private</option>
                  <option value="unlisted">Unlisted</option>
                  <option value="public">Public</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="categorySelect" class="form-label">Category</label>
                <select class="form-select" id="categorySelect">
                  <option value="22">People & Blogs</option>
                  <option value="1">Film & Animation</option>
                  <option value="2">Autos & Vehicles</option>
                  <option value="10">Music</option>
                  <option value="15">Pets & Animals</option>
                  <option value="17">Sports</option>
                  <option value="19">Travel & Events</option>
                  <option value="20">Gaming</option>
                  <option value="21">Videoblogging</option>
                  <option value="23">Comedy</option>
                  <option value="24">Entertainment</option>
                  <option value="25">News & Politics</option>
                  <option value="26">Howto & Style</option>
                  <option value="27">Education</option>
                  <option value="28">Science & Technology</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="languageSelect" class="form-label">Video Language</label>
                <select class="form-select" id="languageSelect">
                  <option value="en">English</option>
                  <option value="ar">Arabic</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="it">Italian</option>
                  <option value="pt">Portuguese</option>
                  <option value="ru">Russian</option>
                  <option value="ja">Japanese</option>
                  <option value="ko">Korean</option>
                  <option value="zh">Chinese</option>
                  <option value="hi">Hindi</option>
                  <option value="tr">Turkish</option>
                  <option value="ur">Urdu</option>
                  <option value="fa">Farsi</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="recordingDate" class="form-label">Recording Date</label>
                <input type="date" class="form-control" id="recordingDate">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="thumbnailFile" class="form-label">Thumbnail (optional)</label>
            <input type="file" class="form-control" id="thumbnailFile" accept="image/*">
            <div class="form-text">Recommended: 1280x720 pixels, max 2MB</div>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="switchAccount">
            <label class="form-check-label" for="switchAccount">
              Switch YouTube Account (Re-authenticate)
            </label>
            <div class="form-text">Check this to log in with a different YouTube account</div>
          </div>
        </div>
        <!-- Coming Soon Message (for other platforms) -->
        <div id="comingSoonMessage" style="display:none;">
          <div class="alert alert-info">
            <h5>Coming Soon!</h5>
            <p>Direct upload to <span id="platformName"></span> is coming soon.</p>
            <p>Please download the video and upload manually for now.</p>
            <p class="mb-0"><strong>Video Path:</strong> <code id="videoPath"></code></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="uploadButton" onclick="performUpload()">Upload</button>
      </div>
    </div>
  </div>
</div>

<!-- Upload Progress Modal -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Uploading Video</h5>
      </div>
      <div class="modal-body">
        <p id="uploadProgressText">Uploading to YouTube...</p>
        <div class="progress">
          <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let checkingStatus = false;
let checkStatusInterval = null;
let statusCheckCount = 0;
const MAX_STATUS_CHECKS = 120;

function showConnectYouTubePrompt() {
    document.getElementById('youtube-auth-required').style.display = '';
}
function hideConnectYouTubePrompt() {
    document.getElementById('youtube-auth-required').style.display = 'none';
}

function showUploadDialog() {
  // Load video metadata with defaults
  fetch('/api/video_metadata')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('videoTitle').value = data.title || 'Untitled';
        let description = data.description || '';
        if (description.length > 5000) {
          description = description.substring(0, 5000);
        }
        document.getElementById('videoDescription').value = description;
        document.getElementById('descriptionCount').textContent = description.length;
        document.getElementById('videoTags').value = data.tags ? data.tags.join(', ') : '';
        if (data.language) {
          document.getElementById('languageSelect').value = data.language;
        }
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordingDate').value = today;
      }
    })
    .catch(error => {
      console.error('Error loading metadata:', error);
    });
  onPlatformChange();
  const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
  modal.show();
}

function onPlatformChange() {
  const platform = document.getElementById('platformSelect').value;
  const youtubeOptions = document.getElementById('youtubeOptions');
  const comingSoonMessage = document.getElementById('comingSoonMessage');
  const uploadButton = document.getElementById('uploadButton');
  if (platform === 'youtube' || platform === 'youtube_shorts') {
    youtubeOptions.style.display = 'block';
    comingSoonMessage.style.display = 'none';
    uploadButton.style.display = 'block';
    if (platform === 'youtube_shorts') {
      alert('NOTE: YouTube Shorts are intended for videos of 60 seconds or less.');
    }
  } else if (platform && platform !== '') {
    youtubeOptions.style.display = 'none';
    comingSoonMessage.style.display = 'block';
    uploadButton.style.display = 'none';
    document.getElementById('platformName').textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
    document.getElementById('videoPath').textContent = 'workspace/final/final.mp4';
  } else {
    youtubeOptions.style.display = 'none';
    comingSoonMessage.style.display = 'none';
    uploadButton.style.display = 'block';
  }
}

async function performUpload() {
  const platform = document.getElementById('platformSelect').value;
  if (!platform) { alert('Please select a platform'); return; }
  if (platform !== 'youtube' && platform !== 'youtube_shorts') return;

  // Validate required fields
  const title = document.getElementById('videoTitle').value.trim();
  if (!title) { alert('Please enter a video title'); return; }

  // Thumbnail upload
  let thumbnailData = null;
  const thumbnailFile = document.getElementById('thumbnailFile').files[0];
  if (thumbnailFile) {
    thumbnailData = await fileToBase64(thumbnailFile);
  }
  // Clean and validate tags
  const tagsInput = document.getElementById('videoTags').value;
  const tags = tagsInput.split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0 && tag.length <= 30)
    .slice(0, 30); // YouTube max 30 tags

  // Gather upload data
  const uploadData = {
    platform: platform,
    title: title,
    description: document.getElementById('videoDescription').value,
    tags: tags,
    privacy: document.getElementById('privacySelect').value,
    category: document.getElementById('categorySelect').value,
    language: document.getElementById('languageSelect').value,
    recording_date: document.getElementById('recordingDate').value,
    switch_account: document.getElementById('switchAccount').checked,
    thumbnail: thumbnailData
  };

  // Close upload modal
  bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();

  // Show progress modal
  const progressModal = new bootstrap.Modal(document.getElementById('uploadProgressModal'));
  progressModal.show();

  // Start upload
  fetch('/api/upload_video', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(uploadData)
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      progressModal.hide();
      if (data.auth_required) {
        showConnectYouTubePrompt();
      }
      alert('Upload failed: ' + (data.message || 'Unknown error'));
    } else {
      checkUploadProgress();
    }
  })
  .catch(error => {
    progressModal.hide();
    alert('Upload error: ' + error.message);
  });
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

function checkUploadProgress() {
  fetch('/api/upload_progress')
    .then(response => response.json())
    .then(data => {
      if (data.auth_required) {
        showConnectYouTubePrompt();
        return;
      } else {
        hideConnectYouTubePrompt();
      }
      if (data.progress !== undefined) {
        document.getElementById('uploadProgressBar').style.width = data.progress + '%';
        document.getElementById('uploadProgressText').textContent = data.message || 'Uploading...';
        if (data.complete) {
          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('uploadProgressModal')).hide();
            if (data.success) {
              alert('Video uploaded successfully! Video ID: ' + data.video_id);
            } else {
              alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
          }, 1000);
        } else if (!data.error) {
          setTimeout(checkUploadProgress, 1000);
        }
      }
    })
    .catch(error => {
      setTimeout(checkUploadProgress, 2000);
    });
}

function showVideo(filename) {
  document.getElementById('video-source').src = '/static/videos/' + filename + '?t=' + new Date().getTime();
  document.getElementById('download-link').href = '/static/videos/' + filename + '?download=1';
  const videoElement = document.querySelector('video');
  videoElement.load();
  videoElement.play().catch(e => { });
  document.getElementById('loading-indicator').style.display = 'none';
  document.getElementById('video-player').style.display = 'block';
  if (checkStatusInterval) {
    clearInterval(checkStatusInterval);
    checkStatusInterval = null;
  }
  statusCheckCount = 0;
}

function updateProgress(progress, message) {
  const progressBar = document.getElementById('progress-bar');
  const statusMessage = document.getElementById('status-message');
  if (progressBar) {
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
  }
  if (statusMessage) {
    statusMessage.textContent = message;
  }
}

function regenerateVideo() {
  if (confirm('Are you sure you want to regenerate the video?')) {
    statusCheckCount = 0;
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('video-player').style.display = 'none';
    updateProgress(0, 'Starting video generation...');
    fetch('{{ url_for("api_final_render") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
      }
    }).then(response => response.json()).then(data => {
      if (data.success) {
        updateProgress(10, 'Video generation started. Progress will update automatically.');
        if (checkStatusInterval) clearInterval(checkStatusInterval);
        checkStatusInterval = setInterval(checkStatus, 5000);
        setTimeout(checkStatus, 1000);
      } else {
        updateProgress(0, 'Failed to start video generation: ' + (data.message || 'Unknown error'));
      }
    }).catch(error => {
            updateProgress(0, 'Error: ' + error.message);
    });
  }
}

function checkStatus() {
  if (checkingStatus) return;
  checkingStatus = true;
  statusCheckCount++;
  fetch('{{ url_for("api_final_render") }}')
    .then(response => response.json())
    .then(data => {
      if (data.progress !== undefined) {
        updateProgress(data.progress, data.message || 'Processing...');
      }
      if (data.status === 'complete') {
        if (data.filename) {
          showVideo(data.filename);
        } else {
          showVideo('final.mp4');
        }
      } else if (data.status === 'error') {
        updateProgress(0, data.message || 'An error occurred');
        if (checkStatusInterval) {
          clearInterval(checkStatusInterval);
          checkStatusInterval = null;
        }
      } else if (data.status === 'not_started') {
        updateProgress(0, data.message || 'Click "Generate Video" to start');
        if (checkStatusInterval) {
          clearInterval(checkStatusInterval);
          checkStatusInterval = null;
        }
      } else if (statusCheckCount >= MAX_STATUS_CHECKS) {
        updateProgress(0, 'Status check timeout. Please refresh the page.');
        if (checkStatusInterval) {
          clearInterval(checkStatusInterval);
          checkStatusInterval = null;
        }
      }
      checkingStatus = false;
    })
    .catch(error => {
      updateProgress(0, 'Error checking status: ' + error.message);
      checkingStatus = false;
      if (statusCheckCount >= 10 && checkStatusInterval) {
        clearInterval(checkStatusInterval);
        checkStatusInterval = null;
      }
    });
}

// Track description length -- make sure element exists first!
document.addEventListener('DOMContentLoaded', function() {
  // Description character counter live update
  const descriptionEl = document.getElementById('videoDescription');
  if (descriptionEl) {
    descriptionEl.addEventListener('input', function() {
      const length = this.value.length;
      document.getElementById('descriptionCount').textContent = length;
      const countElement = document.getElementById('descriptionCount');
      if (length > 4500) {
        countElement.style.color = 'red';
      } else if (length > 4000) {
        countElement.style.color = 'orange';
      } else {
        countElement.style.color = '';
      }
    });
  }
  // Initial status check for video progress polling, only if video isn't already showing
  const videoPlayer = document.getElementById('video-player');
  const videoSource = document.getElementById('video-source');
  if (!(videoPlayer && videoPlayer.style.display !== 'none' && videoSource && videoSource.src)) {
    checkStatus();
    checkStatusInterval = setInterval(checkStatus, 5000);
  }
});

// Clean up interval on unload
window.addEventListener('beforeunload', function() {
  if (checkStatusInterval) {
    clearInterval(checkStatusInterval);
  }
});
</script>
{% endblock %}